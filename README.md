# Сравнение Puppet и Ansible
## Обзор

Сегодняшние специалисты по системному администрированию и devops должны в среднем управлять гораздо большим количеством серверов, на которых размещено гораздо большее количество приложений. Таким образом, такие инструменты, как Puppet и Ansible, быстро становятся важными компонентами для управления большим количеством серверов.

Puppet поддерживает как чистый Ruby, так и настроенный DSL для CLI, только поддержка для Ruby устарела. Это плохие новости для тех, кто изучил только Ruby, а не внутренний DSL.

Ansible обошла Puppet, чтобы захватить самую большую долю рынка в индустрии управления конфигурациями с [лидирующей долей 26,5%](https://www.datanyze.com/market-share/configuration-management).

Попытаемся сравнить Puppet и Ansible.

## Ключевые особенности

|                              | Puppet                                                     | Ansible                                      |
| ---------------------------- | ---------------------------------------------------------- | -------------------------------------------- |
| Архитектура                  | Клиент-Серверная                                           | Безагентная. Управление по SSH.              |
| Синтаксис                    | Puppet DSL                                                 | YAML                                         |
| На чем написан               | Ruby                                                       | Python                                       |
| Подключение к целевой машине | Агент нацелевой машине подключается по SSL к Puppet Server | Ansible подключается к целевой машине по SSH |

## Различия в настройках 

Чтобы настроить Ansible, вам нужно назначить отдельный узел в качестве управляющего узла. В действительности, любой из ваших узлов может быть управляющим узлом. Нет необходимости устанавливать клиентское программное обеспечение на других ваших узлах. Создайте пару ключей SSH на вашем управляющем узле, а затем скопируйте ее на остальные узлы. Создайте файл инвентаризации для ваших узлов Ansible. Ansible будет использовать SSH-соединения с вашими контролируемыми узлами для запуска ваших playbook.
Для выполнения raw-комманд на управляемых узлах ничего устанавливать не нужно. Для работы с модулями Ansible, которые обеспечивают декларативный подход, на управляемых узлах должен быть установлен интерпретатор Python. Также можно обойтись вообще без управляющего узла. Для этого необходимо установить Ansible на каждый управляемы хост, указать ему в каком репозитории храняться конфигурации и добавить Ansible в планировщик. Таким образом реализуется "агентский" подход, аналогичный используемому в Puppet.

Для Puppet, установка немного сложнее. Вам нужно будет развернуть сервер (-ы) и установить программное обеспечение Puppet Agent на каждом клиенте. Также необходимо настроить синхронизацию с сервером времени на мастерах и агентах. Для подписания клиентских сертификатов вам потребуется сервер сертификации. Для балансировки нагрузки и повышения отказоустойчивости серверы Puppet можно объединять в кластер 

## Масштабируемость и транспортные механизмы 

Ansible использует механизм транспорта по умолчанию «smart», который обычно разрешается в SSH. Он откроет SSH-соединение и создаст временный каталог. После закрытия этого соединения Ansible открывает второе соединение для копирования кода модуля Ansible и исходного кода Ansible. Ansible закроет это соединение перед тем, как открыть третье, последнее соединение для выполнения кода. Первая функция, которую может использовать Ansible, называется ControlPersist, и она опирается на постоянные сокеты, чтобы сократить время и рукопожатие, необходимые для нескольких соединений. Ansible может быть сконфигурирован для обработки большего количества узлов инвентаря за один раз, настроив переменную forks в конфигурации Ansible.

Транспортным механизмом Puppet является HTTPS, который управляется через SSL-сертификаты. Один сервер Puppet будет обрабатывать запросы конфигурации из вашего инвентаря клиентов Puppet. Каждый клиент отправляет факты о Puppet мастеру и отправляет запрос на каталог Puppet. Затем мастер отправит каталог в ответ. Затем клиент обрабатывает каталог, проверяя каждый ресурс на соответствие требуемому состоянию конфигурации, указанному в каталоге.

В частности, модель обработки Puppet выделяет поток JRuby из пула потоков для обработки каждого входящего клиентского соединения. По мере того как количество ваших узлов увеличивается до больших размеров, вы можете настроить Puppet для лучшего масштабирования, увеличив число потоков JRuby, доступных в пуле. Вы можете установить его, как правило, так же высоко, как количество ядер ЦП на машина, однако, следует помнить, что для этого потребуется больше оперативной памяти. 

## Проблемы Puppet в сравнении с Ansible

|                                     | Puppet                                                       | Ansible                                       |
| ----------------------------------- | ------------------------------------------------------------ | --------------------------------------------- |
| Дублированный блок кода в 2 модулях | вызовет ошибку, так как Puppet деклатирован                  | Не вызовет,  так как Ansible и императивен.   |
| Для запуска задания на 1 сервере    | Puppet предлагают использовать MCollective. Настраивать его сложно. Поэтому некоторые просто запускают puppet agent -t через pssh, ansible. | `ansible-playbook -i "imac1-local," user.yml` |
| Динамические среды в Puppet         | **r10k** – это просто бесполезный костыль, написанный на ruby с монументально скудным функционалом. Подробнее можно прочитать здесь https://avalon.land/blog/it/puppet-with-r10k-puppet-best-practice/ | Ansible запускается из нужной вам ветки.      |
|                                     |                                                              |                                               |
|                                     |                                                              |                                               |

## Примеры кода

|                              | Puppet                                                       | Ansible                                                      |
| ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Установка пакета             | package { 'install ntpdate':<br/>  ensure => installed,<br/>  name   => ntpdate,<br/>} | - name: install ntpdate<br/>  package:<br/>    name: ntpdate<br/>    state: present</p> |
| Удаление пакета              | package { 'remove openssl':<br/>  ensure => absent,<br/>  name   => openssl,<br/>} | - name: remove openssl<br/>  package:<br/>    name: "openssl"<br/>    state: absent |
| Установка нескольких пакетов | $enhancers = [ 'screen', <br/>               'strace' ]<br/>package { $enhancers: <br/>ensure => 'latest' } | - name: install multiple packages<br/>  package:<br/>    name:<br/>      - screen<br/>      - strace<br/>    state: latest |
|                              |                                                              |                                                              |
|                              |                                                              |                                                              |

## 
